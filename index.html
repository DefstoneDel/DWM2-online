<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drift With Myth 2</title>
  <style>
    /* Simplified: your full CSS stays exactly as in DWMfixed.html */
    body { background-color: #0a0a1a; color: #00bfff; font-family: 'Inter', monospace, sans-serif; }
    #rankingView, #gameView { max-width: 400px; margin: 20px auto; }
    #gameView { display: none; }
    #globalRankList li { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,191,255,0.2); padding: 5px 0; }
    .rank-score { color: #ff8c00; font-weight: bold; }
    .rank-highlight { background: rgba(255,140,0,0.15); border-left: 4px solid #ff8c00; }
    #gameCanvas { width: 100%; height: 600px; background: black; }
  </style>
</head>
<body>
  <div id="rankingView">
    <h1 style="color:#ff8c00;text-align:center;">DRIFT WITH MYTH II</h1>
    <h2>HIGH SCORES</h2>
    <ul id="globalRankList"></ul>
    <div>
      <p><span style="color:#00bfff;">YOUR BEST TIME:</span> <span id="localBestScore">---</span></p>
    </div>
    <input type="text" id="playerNameInput" maxlength="8" placeholder="PLAYER" style="text-transform:uppercase;" />
    <button id="playButton" onclick="startGameView()">START DRIFTING!</button>
  </div>

  <div id="gameView">
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div id="gameOverScreen" style="display:none;text-align:center;background:rgba(0,0,0,0.9);color:#ff8c00;position:absolute;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;">
      <div>
        <h1>CRASH!</h1>
        <p>Total Drift Time:</p>
        <p id="finalScoreText"></p>
        <p id="newRecordMsg" style="color:#00ff00;font-weight:bold;"></p>
        <button onclick="showRankingView()">EXIT SIMULATION</button>
      </div>
    </div>
  </div>

  <script>
    /* --- Minimal local game logic from your existing DWMfixed.html --- */
    const LOCAL_BEST_KEY = 'blockDodgerLocalBestTime';
    const PLAYER_NAME_KEY = 'blockDodgerPlayerName';
    const FPS = 60;
    let frameCount = 0;
    let isGameOver = false;
    let gameLoopId = null;

    function formatScore(s) { return s + 's'; }
    function loadLocalBest() { return Number(localStorage.getItem(LOCAL_BEST_KEY)) || 0; }
    function saveLocalBest(score) {
      const prev = loadLocalBest();
      if (score > prev) localStorage.setItem(LOCAL_BEST_KEY, score);
      return loadLocalBest();
    }

    function showRankingView() {
      document.getElementById('rankingView').style.display = 'block';
      document.getElementById('gameView').style.display = 'none';
      document.getElementById('gameOverScreen').style.display = 'none';
      updateLeaderboardDisplay();
    }

    function startGameView() {
      document.getElementById('rankingView').style.display = 'none';
      document.getElementById('gameView').style.display = 'block';
      document.getElementById('gameOverScreen').style.display = 'none';
      startGame();
    }

    function startGame() {
      frameCount = 0;
      isGameOver = false;
      if (gameLoopId) cancelAnimationFrame(gameLoopId);
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
      if (isGameOver) return;
      frameCount++;
      if (frameCount / FPS > 5) { // simulate a quick game
        gameOver();
        return;
      }
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    function gameOver() {
      if (isGameOver) return;
      isGameOver = true;
      const score = Math.floor(frameCount / FPS);
      const best = saveLocalBest(score);
      document.getElementById('finalScoreText').textContent = formatScore(score);
      document.getElementById('gameOverScreen').style.display = 'flex';
      document.getElementById('newRecordMsg').textContent = score >= best ? 'NEW RECORD!' : '';
    }

    window.onload = showRankingView;
  </script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script>
  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyDJ4-PX0BkxLCAAzgt5XheVW6V5EAiCt-Q",
      authDomain: "m-8b9af.firebaseapp.com",
      projectId: "m-8b9af",
      storageBucket: "m-8b9af.firebasestorage.app",
      messagingSenderId: "191155309081",
      appId: "1:191155309081:web:8b4eccd49997b2ef4e3888"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.warn(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // âœ… Persistent anonymous login
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => auth.signInAnonymously().catch(()=>{}))
      .catch(e => console.warn("Persistence failed:", e));

    auth.onAuthStateChanged(u => {
      if(u){ currentUser = u; console.log("Signed in:", u.uid); }
      else auth.signInAnonymously().catch(()=>{});
    });

    // Wait for auth
    function waitForAuth(){ return new Promise(r => {
      const chk = setInterval(()=>{ if(currentUser){ clearInterval(chk); r(currentUser); }},100);
    });}

    async function saveScoreToFirebase(name, score){
      const user = await waitForAuth();
      const ref = db.collection("leaderboard").doc(user.uid);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({ name, score, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else {
        const prev = snap.data().score || 0;
        if(score > prev){
          await ref.set({ name, score, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        } else if(snap.data().name !== name){
          await ref.update({ name });
        }
      }
    }

    async function loadLeaderboard(){
      const q = await db.collection("leaderboard").orderBy("score","desc").limit(5).get();
      const out=[]; q.forEach(d=>out.push(d.data())); return out;
    }

    async function updateLeaderboardDisplay(){
      const list=document.getElementById("globalRankList");
      if(!list) return;
      const rows=await loadLeaderboard();
      list.innerHTML="";
      rows.forEach((r,i)=>{
        const li=document.createElement("li");
        li.innerHTML=`<span>#${i+1}</span><span>${r.name||"PLAYER"}</span><span class="rank-score">${r.score}s</span>`;
        list.appendChild(li);
      });
      document.getElementById("localBestScore").textContent = (loadLocalBest()||0)+'s';
    }

    // âœ… Only update Firestore if new highscore achieved
    const origGameOver = window.gameOver;
    window.gameOver = async function(){
      try{ origGameOver(); }catch(e){ console.warn(e); }
      const finalScore = Math.floor((window.frameCount||0)/(window.FPS||60));
      const bestStored = loadLocalBest();
      const name = (localStorage.getItem(PLAYER_NAME_KEY)||"PLAYER").toUpperCase().slice(0,8);
      if(finalScore >= bestStored){
        console.log("ðŸŽ‰ New record, saving to Firestore:", bestStored);
        await saveScoreToFirebase(name, bestStored);
        await updateLeaderboardDisplay();
      } else {
        console.log("No new highscore, skip Firestore update.");
      }
    };

    window.addEventListener("load", ()=>{
      updateLeaderboardDisplay();
      const nameInput=document.getElementById("playerNameInput");
      nameInput.addEventListener("blur", async e=>{
        const name=(e.target.value||"PLAYER").toUpperCase().slice(0,8);
        localStorage.setItem(PLAYER_NAME_KEY,name);
        const user=await waitForAuth();
        const ref=db.collection("leaderboard").doc(user.uid);
        const snap=await ref.get();
        if(!snap.exists){
          await ref.set({name,score:loadLocalBest(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
        }else{
          await ref.update({name});
        }
        updateLeaderboardDisplay();
      });
    });
  })();
  </script>
</body>
</html>
